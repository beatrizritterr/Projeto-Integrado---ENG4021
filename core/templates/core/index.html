{% load custom_filters %}
{% load static %}
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calend√°rio</title>
    <link rel="stylesheet" href="{% static 'css/estilo/estilo1.css' %}">
</head>
<body>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="{% static 'img/image-removebg-preview.png' %}" alt="Logo" class="sidebar-logo">
            <div class="sidebar-title">Vinculou</div>
        </div>
        
        <nav class="sidebar-menu">
            <a href="{% url 'filtrobusca' %}" class="menu-item">
                <span class="menu-icon">üí¨</span>
                <span class="menu-text">Filtros</span>
            </a>
            <a href="{% url 'avaliacaoprof' %}" class="menu-item">
                <span class="menu-icon">‚≠ê</span>
                <span class="menu-text">Avalia√ß√µes</span>
            </a>
            <a href="{% url 'provasantigas' %}" class="menu-item">
                <span class="menu-icon">üìö</span>
                <span class="menu-text">Provas Antigas</span>
            </a>
            <a href="{% url 'home' %}" class="menu-item active"> 
                <span class="menu-icon">üóìÔ∏è</span>
                <span class="menu-text">Calend√°rio</span>
            </a>
            <a href="{% url 'perfil' %}" class="menu-item">
                <span class="menu-icon">üë§</span>
                <span class="menu-text">Perfil</span>
            </a>
            <a href="{% url 'login' %}" class="menu-item">
                <span class="menu-icon">üîë</span>
                <span class="menu-text">Login</span>
            </a>
            <a href="{% url 'configuracoes' %}" class="menu-item">
                <span class="menu-icon">‚öôÔ∏è</span>
                <span class="menu-text">Configura√ß√µes</span>
            </a>
        </nav>
    </div>

    <div class="header-container">
        <div class="logo-area">
            <div class="menu-icon hamburger" id="menuToggle">‚ò∞</div>
            <img id="logo" src="{% static 'img/image-removebg-preview.png' %}" alt="Logo Vinculou">
        </div>
        
        <div class="user-area">
            <div class="notification-icon">üîî</div>
            <div class="profile-icon">üë§</div>
        </div>
    </div>

    <div class="container">
        
        <aside class="barra-lado">
            <br/><h2 class="titulo-logo">Agenda VinculaPuc</h2>
            <div class="inf-perfil">
                <img id="log" src="{% static 'img/image copy.png' %}"> 
                <p>Ol√°, {{ usuario.username|default:"Usu√°rio" }}!</p>
            </div>
            
            <button class="add-evento-btn" onclick="openModalForAdd()">
                Adicionar Novo Evento
            </button>
            
            <nav class="side-menu">
                <a href="#" class="menuitem"> Configura√ß√µes</a>
            </nav>
        </aside>

        <main class="principal">
            <header class="header-principal">
                <h1 class="titulomes">{{ mes_ano }}</h1>
                
                <div class="header-a">
                    <a href="{% url 'home' %}{{ prev_url }}" class="nav-button">&lt;</a>
                    <a href="{% url 'home' %}?year={{ ano_atual }}&month={{ mes_atual }}" class="nav-button">Hoje</a>
                    <a href="{% url 'home' %}{{ next_url }}" class="nav-button">&gt;</a>
                    
                    <div class="barrapesquisa">
                        <input type="text" placeholder="Buscar eventos...">
                    </div>
                </div>
            </header>
            
            <div class="grid-calendario">
                <div class="dia">Domingo</div>
                <div class="dia">Segunda</div>
                <div class="dia">Ter√ßa</div>
                <div class="dia">Quarta</div>
                <div class="dia">Quinta</div>
                <div class="dia">Sexta</div>
                <div class="dia">S√°bado</div>

                {% for week in month_weeks %}
                    {% for day, weekday in week %}
                        
                        {% if day == 0 %}
                            <div class="mes-passado"></div>
                        {% else %}
                            
                            {% if day == hoje and mes_sendo_renderizado == mes_atual and ano_atual == ano_atual %}
                                <div class="calendario-dia-hoje">
                            {% else %}
                                <div class="calendario-dia">
                            {% endif %}
                                
                            {{ day }}
                            
                            {% with eventos_do_dia=eventos_por_dia|get_item:day %}
                                {% for evento in eventos_do_dia %}
                                    <div class="evento-item {{ evento.categoria }}"
                                        data-event-id="{{ evento.id }}" 
                                        data-titulo="{{ evento.titulo }}" 
                                        data-data-hora="{{ evento.data_hora|date:'Y-m-d\TH:i' }}" 
                                        data-categoria="{{ evento.categoria }}" 
                                        data-descricao="{{ evento.descricao|default:'' }}">
                                        
                                        {{ evento.titulo }} 
                                        
                                        <a href="#" onclick="event.preventDefault(); openModalForEdit('{{ evento.id }}')" title="Editar Evento">‚úèÔ∏è</a>
                                        <a href="#" onclick="event.preventDefault(); deleteEvent('{{ evento.id }}')" title="Excluir Evento">‚ùå</a>
                                    </div>
                                {% endfor %}
                            {% endwith %}
                            
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>
            
        </main>
    </div>

    <div class="modal-overlay" id="eventModalOverlay"></div>
    <div class="modal" id="eventModal">
        <div class="modal-header">
            <h3 id="modalTitle">Adicionar Novo Evento</h3>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="eventoForm" method="post" action="{% url 'adicionar_evento' %}">
                {% csrf_token %}
                
                <input type="hidden" name="event_id" id="event_id">

                <div class="form-group">
                    <label for="id_titulo">T√≠tulo</label>
                    {{ evento_form.titulo }}
                </div>

                <div class="form-group">
                    <label for="id_data_hora">Data e Hora</label>
                    {{ evento_form.data_hora }}
                </div>

                <div class="form-group">
                    <label for="id_categoria">Cor/Categoria</label>
                    {{ evento_form.categoria }}
                </div>

                <div class="form-group">
                    <label for="id_descricao">Descri√ß√£o</label>
                    {{ evento_form.descricao }}
                </div>

                <button type="submit" class="btn-primary" id="submitBtn">Adicionar</button>
            </form>
        </div>
    </div>

    <script>
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const body = document.body;
        

        const modal = document.getElementById('eventModal');
        const modalOverlay = document.getElementById('eventModalOverlay');
        const form = document.getElementById('eventoForm');
        const modalTitle = document.getElementById('modalTitle');
        const submitBtn = document.getElementById('submitBtn');

        function openModal() {
            modal.classList.add('active');
            modalOverlay.classList.add('active');
            body.classList.add('modal-open');
        }

        function closeModal() {
            modal.classList.remove('active');
            modalOverlay.classList.remove('active');
            body.classList.remove('modal-open');
            form.reset();
            form.action = "{% url 'adicionar_evento' %}";
            document.getElementById('event_id').value = ''; 
            modalTitle.textContent = "Adicionar Novo Evento";
            submitBtn.textContent = "Adicionar";
        }

        function openModalForAdd() {
            closeModal();
            openModal();
        }

        function openModalForEdit(eventId) {
            const eventElement = document.querySelector(`[data-event-id="${eventId}"]`);
            if (!eventElement) return;

            document.getElementById('id_titulo').value = eventElement.dataset.titulo;
            document.getElementById('id_data_hora').value = eventElement.dataset.dataHora;
            document.getElementById('id_categoria').value = eventElement.dataset.categoria;
            document.getElementById('id_descricao').value = eventElement.dataset.descricao; 

            form.action = "{% url 'editar_evento' 0 %}".replace('/0/', '/' + eventId + '/');
            
            modalTitle.textContent = "Editar Evento";
            submitBtn.textContent = "Salvar Altera√ß√µes";

            openModal();
        }

        function deleteEvent(eventId) {
            if (confirm("Voc√™ tem certeza que deseja excluir este evento?")) {
                const tempForm = document.createElement('form');
                tempForm.method = 'POST';
                tempForm.action = "{% url 'excluir_evento' 0 %}".replace('/0/', '/' + eventId + '/');
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value; 
                
                tempForm.appendChild(csrfInput);
                document.body.appendChild(tempForm);
                
                tempForm.submit();
            }
        }

        menuToggle.addEventListener('click', function() {
            sidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
            body.classList.add('sidebar-open');
        });

        sidebarOverlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
            body.classList.remove('sidebar-open');
        });
        
        const menuItems = document.querySelectorAll('.sidebar-menu .menu-item');
        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                menuItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                body.classList.remove('sidebar-open');
            });
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal(); 
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                body.classList.remove('sidebar-open');
            }
        });

        modalOverlay.addEventListener('click', closeModal);
        
    </script>
</body>
</html>